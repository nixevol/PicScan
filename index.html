<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âõ∫ÁßªÂ∑•ÂçïÊï∞ÊçÆÂ§ÑÁêÜÂ∑•ÂÖ∑</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            height: 100vh;
            padding: 20px;
            padding-bottom: 50px; /* ‰∏∫ÁâàÊùÉÊ†èÁïôÁ©∫Èó¥ */
            color: #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: #fff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        /* ‰æßËæπÊ†èÈÅÆÁΩ© */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }
        /* ‰æßËæπÊ†è */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 36px; /* ‰∏∫ÁâàÊùÉÊ†èÁïôÁ©∫Èó¥ */
            width: 730px;
            max-width: 90vw;
            background: #fff;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }
        .sidebar.show {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #ebeef5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sidebar-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background 0.2s;
        }
        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .sidebar-body {
            flex: 1;
            overflow: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .toolbar {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .toolbar-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toolbar-item label {
            font-size: 13px;
            color: #606266;
            white-space: nowrap;
            font-weight: 500;
        }
        .toolbar-item input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 6px;
            font-size: 13px;
            width: 280px;
            transition: all 0.2s;
        }
        .toolbar-item input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .upload-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 32px;
            border: 2px dashed #c0c4cc;
            border-radius: 8px;
            background: #fafbfc;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 240px;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f3ff;
            transform: translateY(-1px);
        }
        .upload-area.dragover {
            border-color: #667eea;
            background: #e8ecff;
            border-style: solid;
        }
        .upload-area.has-file {
            border-color: #67c23a;
            border-style: solid;
            background: #f0f9eb;
        }
        .upload-area .icon {
            font-size: 22px;
        }
        .upload-area .text {
            font-size: 14px;
            color: #606266;
            font-weight: 500;
        }
        .upload-area.has-file .text {
            color: #67c23a;
        }
        .upload-area.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            border-color: #c0c4cc;
            background: #f5f7fa;
        }
        .upload-area.disabled:hover {
            transform: none;
            border-color: #c0c4cc;
            background: #f5f7fa;
        }
        .toolbar-item.disabled label,
        .toolbar-item.disabled input {
            opacity: 0.5;
            pointer-events: none;
        }
        input[type="file"] {
            display: none;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
        }
        .btn-success {
            background: linear-gradient(135deg, #67c23a 0%, #5daf34 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(103, 194, 58, 0.3);
        }
        .btn-success:hover {
            box-shadow: 0 4px 12px rgba(103, 194, 58, 0.4);
            transform: translateY(-1px);
        }
        .btn-danger {
            background: linear-gradient(135deg, #f56c6c 0%, #e74c3c 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(245, 108, 108, 0.3);
        }
        .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(245, 108, 108, 0.4);
            transform: translateY(-1px);
        }
        .btn-default {
            background: #fff;
            color: #606266;
            border: 1px solid #dcdfe6;
        }
        .btn-default:hover {
            background: #f5f7fa;
            border-color: #c0c4cc;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        .file-actions {
            display: none;
            align-items: center;
            gap: 8px;
        }
        .file-actions.show {
            display: flex;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card.flex-grow {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin-bottom: 0;
            overflow: hidden;
        }
        .card.flex-grow .table-container {
            flex: 1;
            max-height: none;
            min-height: 0;
            overflow-y: auto;
            overflow-x: auto;
        }
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-bottom: 1px solid #ebeef5;
            background: #fafbfc;
        }
        .card-header h2 {
            font-size: 14px;
            font-weight: 600;
            color: #303133;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-body {
            padding: 20px;
        }
        .progress-section {
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ebeef5;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease-out;
            border-radius: 4px;
        }
        .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .status-text {
            font-size: 13px;
            color: #606266;
        }
        .status-text.error {
            color: #f56c6c;
        }
        .progress-percent {
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
        }
        .result-count {
            font-size: 12px;
            color: #909399;
            font-weight: normal;
            margin-left: 8px;
        }
        .sidebar-header .result-count {
            font-size: 15px;
            color: #cccaca;
            font-weight: 600;

        }
        .table-container {
            max-height: 40vh;
            overflow: auto;
        }
        .history-table-container {
            flex: 1;
            overflow: auto;
            min-height: 0;
        }
        .sidebar-body .result-table {
            font-size: 11px;
        }
        .sidebar-body .result-table th,
        .sidebar-body .result-table td {
            padding: 8px 10px;
        }
        .sidebar-body .result-table th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f5f7fa;
        }
        .history-row {
            transition: background-color 0.2s;
        }
        .history-row:hover {
            background: #f5f7fa;
        }
        .history-row.disabled {
            opacity: 0.6;
        }
        .link-btn {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        .link-btn:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        .link-btn.disabled {
            color: #c0c4cc;
            cursor: not-allowed;
            text-decoration: none;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .result-table th,
        .result-table td {
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid #ebeef5;
            white-space: nowrap;
        }
        .result-table th {
            background: #f5f7fa;
            color: #606266;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .result-table tr.new-row {
            animation: rowHighlight 0.5s ease-out;
        }
        @keyframes rowHighlight {
            from { background-color: #e1f3d8; }
            to { background-color: transparent; }
        }
        .empty-cell {
            color: #c0c4cc;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #909399;
            font-size: 13px;
        }
        /* Áä∂ÊÄÅÊ†áÁ≠æ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .status-badge.completed {
            background: #e1f3d8;
            color: #67c23a;
        }
        .status-badge.processing {
            background: #e8ecff;
            color: #667eea;
        }
        .status-badge.cancelled {
            background: #fef0e6;
            color: #e6a23c;
        }
        .status-badge.error {
            background: #fde2e2;
            color: #f56c6c;
        }
        /* Êìç‰ΩúÊåâÈíÆÁªÑ */
        .action-btns {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        /* ÂºπÁ™óÈÅÆÁΩ©Â±Ç */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }
        .modal-overlay.hiding {
            opacity: 0;
        }
        /* ÂºπÁ™óÂÆπÂô® */
        .modal {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            min-width: 380px;
            max-width: 460px;
            transform: scale(0.9) translateY(-20px);
            transition: transform 0.2s ease-out;
        }
        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }
        .modal-overlay.hiding .modal {
            transform: scale(0.9) translateY(-20px);
        }
        /* ÂºπÁ™óÂ§¥ÈÉ® */
        .modal-header {
            padding: 18px 24px;
            border-bottom: 1px solid #ebeef5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            margin: 0;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 22px;
            color: #909399;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: #f5f7fa;
            color: #303133;
        }
        /* ÂºπÁ™óÂÜÖÂÆπ */
        .modal-body {
            padding: 28px 24px;
            color: #606266;
            font-size: 14px;
            line-height: 1.6;
        }
        .modal-body .icon {
            font-size: 52px;
            text-align: center;
            margin-bottom: 16px;
        }
        .modal-body .message {
            text-align: center;
            font-size: 15px;
            color: #303133;
            margin-bottom: 8px;
        }
        .modal-body .detail {
            text-align: center;
            color: #909399;
            font-size: 13px;
            margin-top: 8px;
        }
        /* ÂºπÁ™óÂ∫ïÈÉ® */
        .modal-footer {
            padding: 14px 24px 20px;
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        .modal-footer .btn {
            min-width: 80px;
            justify-content: center;
        }
        /* Ê∂àÊÅØÂºπÁ™óÊ†∑Âºè */
        .modal-message .modal-body {
            text-align: center;
        }
        .modal-message.success .modal-header {
            border-bottom-color: #e1f3d8;
        }
        .modal-message.success .modal-body .icon {
            color: #67c23a;
        }
        .modal-message.error .modal-header {
            border-bottom-color: #fde2e2;
        }
        .modal-message.error .modal-body .icon {
            color: #f56c6c;
        }
        .modal-message.warning .modal-header {
            border-bottom-color: #faecd8;
        }
        .modal-message.warning .modal-body .icon {
            color: #e6a23c;
        }
        .modal-message.info .modal-header {
            border-bottom-color: #e1f3ff;
        }
        .modal-message.info .modal-body .icon {
            color: #667eea;
        }
        /* Toast ËΩªÊèêÁ§∫ */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: rgba(48, 49, 51, 0.9);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease-out;
            pointer-events: auto;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success {
            background: rgba(103, 194, 58, 0.95);
        }
        .toast.error {
            background: rgba(245, 108, 108, 0.95);
        }
        .toast.warning {
            background: rgba(230, 162, 60, 0.95);
        }
        /* Âä†ËΩΩÊåáÁ§∫Âô® */
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* ÁâàÊùÉÂ£∞Êòé */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            padding: 10px 20px;
            font-size: 12px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        .footer a {
            color: #fff;
            text-decoration: none;
            font-weight: 600;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        /* ‰∏∫Â∫ïÈÉ®ÁâàÊùÉÁïôÂá∫Á©∫Èó¥ */
        .container {
            padding-bottom: 50px;
        }
    </style>
</head>
<body>
    <!-- Toast ÂÆπÂô® -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ÂºπÁ™óÈÅÆÁΩ©Â±Ç -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal modal-message" id="modal">
            <div class="modal-header">
                <h3 id="modalTitle">ÊèêÁ§∫</h3>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="icon" id="modalIcon">‚ÑπÔ∏è</div>
                <div class="message" id="modalMessage"></div>
                <div class="detail" id="modalDetail"></div>
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-primary" id="modalConfirm">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìä Âõ∫ÁßªÂ∑•ÂçïÊï∞ÊçÆÂ§ÑÁêÜÂ∑•ÂÖ∑</h1>
            <div class="header-actions">
                <button class="btn btn-primary btn-sm" id="historyToggleBtn">üìã ÂéÜÂè≤ËÆ∞ÂΩï</button>
            </div>
        </div>
        
        <div class="toolbar">
            <div class="toolbar-item">
                <div class="upload-area" id="uploadArea">
                    <span class="icon">üìÅ</span>
                    <span class="text" id="uploadText">ÊãñÊãΩÊàñÁÇπÂáª‰∏ä‰º†ZIP</span>
                </div>
                <input type="file" id="fileInput" accept=".zip">
            </div>
            <div class="toolbar-item" id="xlsxFileItem" style="display:none;">
                <label>ExcelÊñá‰ª∂:</label>
                <input type="text" id="xlsxFileName" placeholder="ÁïôÁ©∫Ëá™Âä®Êü•ÊâæÔºåÊàñÊåáÂÆöÊñá‰ª∂Âêç">
            </div>
            <div class="file-actions" id="fileActions">
                <button class="btn btn-success btn-sm" id="startBtn">‚ñ∂ ÂºÄÂßãÂ§ÑÁêÜ</button>
                <button class="btn btn-default btn-sm" id="cancelBtn">‚úï ÂèñÊ∂à</button>
            </div>
        </div>
        
        <div class="card progress-section" id="progressContainer">
            <div class="card-body">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="status-row">
                    <span class="status-text" id="statusMessage">Á≠âÂæÖ‰∏ä‰º†...</span>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <button class="btn btn-primary btn-sm" id="historyResumeBtn" style="display:none;">‚ñ∂ ÁªßÁª≠Â§ÑÁêÜ</button>
                        <button class="btn btn-danger btn-sm" id="cancelTaskBtn" style="display:none;">‚èπ ÂÅúÊ≠¢‰ªªÂä°</button>
                        <span class="progress-percent" id="progressPercent">0%</span>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="card flex-grow" id="resultContainer" style="display:none;">
            <div class="card-header">
                <h2>üìÑ Â§ÑÁêÜÁªìÊûú <span class="result-count" id="resultCount">(0/0)</span></h2>
                <div class="card-header-actions">
                    <a href="#" class="btn btn-primary btn-sm" id="downloadPartialBtn" style="display:none;">‚¨á ‰∏ãËΩΩÂ∑≤Ëß£Êûê</a>
                    <a href="#" class="btn btn-success btn-sm" id="downloadBtn" style="display:none;">‚¨á ‰∏ãËΩΩÂÆåÊï¥CSV</a>
                </div>
            </div>
            <div class="table-container">
                <table class="result-table" id="resultTable">
                    <thead>
                        <tr>
                            <th>Â∑•ÂçïÂè∑</th>
                            <th>ÁªèÂ∫¶</th>
                            <th>Á∫¨Â∫¶</th>
                            <th>‰∏ä‰º†ÈÄüÁéá</th>
                            <th>‰∏ãËΩΩÈÄüÁéá</th>
                            <th>ECI</th>
                            <th>RSRP</th>
                            <th>SINR</th>
                            <th>NR-CI</th>
                            <th>SS-RSRP</th>
                            <th>SS-SINR</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ‰æßËæπÊ†èÈÅÆÁΩ© -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- ÂéÜÂè≤ËÆ∞ÂΩï‰æßËæπÊ†è -->
    <div class="sidebar" id="historySidebar">
        <div class="sidebar-header">
            <h2>üìã ÂéÜÂè≤ËÆ∞ÂΩï <span class="result-count" id="historyCount"></span></h2>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button class="btn btn-primary btn-sm" id="refreshHistoryBtn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">‚ü≥ Âà∑Êñ∞</button>
                <button class="sidebar-close" id="sidebarClose">√ó</button>
            </div>
        </div>
        <div class="sidebar-body">
            <div class="table-container history-table-container">
                <table class="result-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>‰ªªÂä°ID</th>
                            <th>Áä∂ÊÄÅ</th>
                            <th>ËøõÂ∫¶</th>
                            <th>ÂàõÂª∫Êó∂Èó¥</th>
                            <th>ÂÆåÊàêÊó∂Èó¥</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr><td colspan="6" class="empty-cell">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ÁâàÊùÉÂ£∞Êòé -->
    <footer class="footer">
        ¬© 2025 <a href="#">NIXEVOL</a> ¬∑ Âõ∫ÁßªÂ∑•ÂçïÊï∞ÊçÆÂ§ÑÁêÜÂ∑•ÂÖ∑
    </footer>

    <script>
        let currentTaskId = null;
        let pollInterval = null;
        let lastResultIndex = 0;
        let selectedFile = null;
        let isProcessing = false;

        const uploadArea = document.getElementById('uploadArea');
        const uploadText = document.getElementById('uploadText');
        const fileInput = document.getElementById('fileInput');
        const fileActions = document.getElementById('fileActions');
        const startBtn = document.getElementById('startBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressPercent = document.getElementById('progressPercent');
        const statusMessage = document.getElementById('statusMessage');
        const resultContainer = document.getElementById('resultContainer');
        const resultBody = document.getElementById('resultBody');
        const resultCount = document.getElementById('resultCount');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadPartialBtn = document.getElementById('downloadPartialBtn');
        const cancelTaskBtn = document.getElementById('cancelTaskBtn');
        const historyResumeBtn = document.getElementById('historyResumeBtn');
        const historyBody = document.getElementById('historyBody');
        const historyCount = document.getElementById('historyCount');
        const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
        const toastContainer = document.getElementById('toastContainer');
        const historyToggleBtn = document.getElementById('historyToggleBtn');
        const historySidebar = document.getElementById('historySidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarClose = document.getElementById('sidebarClose');
        
        const fieldOrder = ['Â∑•ÂçïÂè∑', 'ÁªèÂ∫¶', 'Á∫¨Â∫¶', '‰∏ä‰º†ÈÄüÁéáMbps', '‰∏ãËΩΩÈÄüÁéáMbps', 'ECI', 'RSRP', 'SINR', 'NR-CI', 'SS-RSRP', 'SS-SINR'];
        
        const STORAGE_KEY = 'picscan_task_state';
        const STATUS_LABELS = { completed: 'Â∑≤ÂÆåÊàê', processing: 'Â§ÑÁêÜ‰∏≠', cancelled: 'Â∑≤ÂèñÊ∂à', error: 'Â§±Ë¥•' };
        const CLICK_DISABLED_STATUS = ['processing'];
        
        // ÂºπÁ™óÂÖÉÁ¥†
        const modalOverlay = document.getElementById('modalOverlay');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalDetail = document.getElementById('modalDetail');
        const modalIcon = document.getElementById('modalIcon');
        const modalFooter = document.getElementById('modalFooter');
        const modalClose = document.getElementById('modalClose');
        
        // Toast ËΩªÊèêÁ§∫
        function showToast(message, type = 'info', duration = 2500) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            // Ëß¶ÂèëÂä®Áîª
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });
            
            // Ëá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // ÊòæÁ§∫Ê∂àÊÅØÂºπÁ™ó
        function showMessage(type, message, detail = '', title = '') {
            return new Promise((resolve) => {
                modal.classList.remove('success', 'error', 'warning', 'info');
                modal.classList.add(type);
                
                const titles = { success: 'ÊàêÂäü', error: 'ÈîôËØØ', warning: 'Ë≠¶Âëä', info: 'ÊèêÁ§∫' };
                modalTitle.textContent = title || titles[type] || 'ÊèêÁ§∫';
                
                const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
                modalIcon.textContent = icons[type] || '‚ÑπÔ∏è';
                
                modalMessage.textContent = message;
                modalDetail.textContent = detail;
                modalDetail.style.display = detail ? 'block' : 'none';
                
                modalFooter.innerHTML = '<button class="btn btn-primary" id="modalConfirm">Á°ÆÂÆö</button>';
                const confirmBtn = document.getElementById('modalConfirm');
                
                const closeModal = () => {
                    modalOverlay.classList.add('hiding');
                    setTimeout(() => {
                        modalOverlay.classList.remove('show', 'hiding');
                        resolve(true);
                    }, 200);
                };
                
                confirmBtn.onclick = closeModal;
                modalClose.onclick = closeModal;
                
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) closeModal();
                };
                
                modalOverlay.classList.add('show');
            });
        }
        
        // ÊòæÁ§∫Á°ÆËÆ§ÂºπÁ™ó
        function showConfirm(message, detail = '', title = 'Á°ÆËÆ§') {
            return new Promise((resolve) => {
                modal.classList.remove('success', 'error', 'warning', 'info');
                modal.classList.add('warning');
                
                modalTitle.textContent = title;
                modalIcon.textContent = '‚ùì';
                
                modalMessage.textContent = message;
                modalDetail.textContent = detail;
                modalDetail.style.display = detail ? 'block' : 'none';
                
                modalFooter.innerHTML = `
                    <button class="btn btn-default" id="modalCancel">ÂèñÊ∂à</button>
                    <button class="btn btn-danger" id="modalConfirm">Á°ÆÂÆö</button>
                `;
                const confirmBtn = document.getElementById('modalConfirm');
                const cancelBtnModal = document.getElementById('modalCancel');
                
                const closeModal = (result) => {
                    modalOverlay.classList.add('hiding');
                    setTimeout(() => {
                        modalOverlay.classList.remove('show', 'hiding');
                        resolve(result);
                    }, 200);
                };
                
                confirmBtn.onclick = () => closeModal(true);
                cancelBtnModal.onclick = () => closeModal(false);
                modalClose.onclick = () => closeModal(false);
                
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) closeModal(false);
                };
                
                modalOverlay.classList.add('show');
            });
        }
        
        // ‰øùÂ≠ò‰ªªÂä°Áä∂ÊÄÅÂà∞ localStorage
        function saveTaskState() {
            if (!currentTaskId) {
                localStorage.removeItem(STORAGE_KEY);
                return;
            }
            const state = {
                taskId: currentTaskId,
                lastResultIndex: lastResultIndex,
                results: Array.from(resultBody.querySelectorAll('tr')).map(tr => {
                    const cells = tr.querySelectorAll('td');
                    const row = {};
                    fieldOrder.forEach((field, i) => {
                        const cell = cells[i];
                        row[field] = cell && cell.classList.contains('empty-cell') ? null : (cell ? cell.textContent : null);
                    });
                    return row;
                })
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }
        
        // ‰ªé localStorage ÊÅ¢Â§ç‰ªªÂä°Áä∂ÊÄÅ
        function restoreTaskState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return null;
            try {
                return JSON.parse(saved);
            } catch (e) {
                localStorage.removeItem(STORAGE_KEY);
                return null;
            }
        }
        
        // Ê∏ÖÈô§‰ªªÂä°Áä∂ÊÄÅ
        function clearTaskState() {
            localStorage.removeItem(STORAGE_KEY);
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÊòØÂê¶ÊúâÊ≠£Âú®ËøõË°åÁöÑ‰ªªÂä°
        async function checkPendingTask() {
            const state = restoreTaskState();
            if (!state || !state.taskId) return;
            
            try {
                const response = await fetch(`/api/task/${state.taskId}?last_index=0`);
                if (response.status === 404) {
                    clearTaskState();
                    return;
                }
                
                const data = await response.json();
                
                currentTaskId = state.taskId;
                lastResultIndex = state.lastResultIndex || 0;
                
                progressContainer.style.display = 'block';
                resultContainer.style.display = 'flex';
                
                if (state.results && state.results.length > 0) {
                    state.results.forEach(result => {
                        const tr = document.createElement('tr');
                        fieldOrder.forEach(field => {
                            const td = document.createElement('td');
                            const value = result[field];
                            if (value === null || value === undefined || value === '' || value === '-') {
                                td.textContent = '-';
                                td.className = 'empty-cell';
                            } else {
                                td.textContent = value;
                            }
                            tr.appendChild(td);
                        });
                        resultBody.appendChild(tr);
                    });
                }
                
                if (data.status === 'processing') {
                    statusMessage.textContent = data.message || 'Â§ÑÁêÜ‰∏≠...';
                    progressFill.style.width = `${data.progress}%`;
                    progressPercent.textContent = `${data.progress}%`;
                    cancelTaskBtn.style.display = 'inline-flex';
                    cancelTaskBtn.disabled = false;
                    cancelTaskBtn.textContent = '‚èπ ÂÅúÊ≠¢‰ªªÂä°';
                    
                    if (data.total_rows > 0) {
                        resultCount.textContent = `(${data.total_results}/${data.total_rows})`;
                    }
                    
                    startPolling();
                } else if (data.status === 'completed') {
                    handleTaskCompleted(data);
                } else if (data.status === 'cancelled') {
                    handleTaskCancelled(data);
                } else if (data.status === 'error') {
                    handleTaskError(data);
                }
            } catch (error) {
                clearTaskState();
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÊâßË°å
        checkPendingTask();
        loadHistory();

        // Á¶ÅÁî®/ÂêØÁî®‰∏ä‰º†Âå∫Âüü
        function setUploadEnabled(enabled) {
            const xlsxFileItem = document.getElementById('xlsxFileItem');
            
            if (enabled) {
                uploadArea.classList.remove('disabled');
                isProcessing = false;
                // ÊÅ¢Â§ç‰∏ä‰º†ÊñáÊú¨
                if (!selectedFile) {
                    uploadText.textContent = 'ÊãñÊãΩÊàñÁÇπÂáª‰∏ä‰º†ZIP';
                }
            } else {
                uploadArea.classList.add('disabled');
                isProcessing = true;
                // Ê∏ÖÈô§Â∑≤ÈÄâÊñá‰ª∂
                selectedFile = null;
                fileInput.value = '';
                uploadArea.classList.remove('has-file');
                uploadText.textContent = '‰ªªÂä°Â§ÑÁêÜ‰∏≠...';
                fileActions.classList.remove('show');
                // ÈöêËóèÂπ∂Ê∏ÖÁ©∫ExcelÊñá‰ª∂ËæìÂÖ•Ê°Ü
                xlsxFileItem.style.display = 'none';
                document.getElementById('xlsxFileName').value = '';
            }
        }

        // ÁÇπÂáª‰∏ä‰º†Âå∫Âüü
        uploadArea.addEventListener('click', () => {
            if (isProcessing) {
                showToast('ËØ∑Á≠âÂæÖÂΩìÂâç‰ªªÂä°ÂÆåÊàêÂêéÂÜç‰∏ä‰º†Êñ∞Êñá‰ª∂', 'warning');
                return;
            }
            fileInput.click();
        });

        // ÊãñÊãΩ‰∏ä‰º†
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (isProcessing) return;
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (isProcessing) {
                showToast('ËØ∑Á≠âÂæÖÂΩìÂâç‰ªªÂä°ÂÆåÊàêÂêéÂÜç‰∏ä‰º†Êñ∞Êñá‰ª∂', 'warning');
                return;
            }
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.zip')) {
                selectFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (isProcessing) return;
            if (e.target.files.length > 0) {
                selectFile(e.target.files[0]);
            }
        });

        // ÈÄâÊã©Êñá‰ª∂Ôºà‰∏çÁ´ãÂç≥ÂºÄÂßãÔºâ
        function selectFile(file) {
            if (isProcessing) return;
            selectedFile = file;
            uploadArea.classList.add('has-file');
            uploadText.textContent = file.name;
            fileActions.classList.add('show');
            document.getElementById('xlsxFileItem').style.display = 'flex';
        }

        // ÂèñÊ∂àÈÄâÊã©
        cancelBtn.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            uploadArea.classList.remove('has-file');
            uploadText.textContent = 'ÊãñÊãΩÊàñÁÇπÂáª‰∏ä‰º†ZIP';
            fileActions.classList.remove('show');
            document.getElementById('xlsxFileItem').style.display = 'none';
            document.getElementById('xlsxFileName').value = '';
        });

        // ÂºÄÂßãÂ§ÑÁêÜ
        startBtn.addEventListener('click', () => {
            if (selectedFile) {
                handleFile(selectedFile);
            }
        });

        // ÂèñÊ∂à‰ªªÂä°
        cancelTaskBtn.addEventListener('click', async () => {
            if (!currentTaskId) return;
            
            cancelTaskBtn.disabled = true;
            cancelTaskBtn.innerHTML = '<span class="loading-spinner"></span> ÂÅúÊ≠¢‰∏≠';
            
            try {
                const response = await fetch(`/api/cancel/${currentTaskId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'ÂèñÊ∂àÂ§±Ë¥•');
                }
            } catch (error) {
                showToast(`ÂÅúÊ≠¢Â§±Ë¥•: ${error.message}`, 'error');
                cancelTaskBtn.disabled = false;
                cancelTaskBtn.textContent = '‚èπ ÂÅúÊ≠¢‰ªªÂä°';
            }
        });

        async function handleFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            const xlsxFileName = document.getElementById('xlsxFileName').value.trim();
            if (xlsxFileName) {
                formData.append('xlsx_filename', xlsxFileName);
            }

            try {
                lastResultIndex = 0;
                resultBody.innerHTML = '';
                resultCount.textContent = '(0/0)';
                downloadBtn.style.display = 'none';
                downloadPartialBtn.style.display = 'none';
                
                fileActions.classList.remove('show');
                
                statusMessage.textContent = 'Ê≠£Âú®‰∏ä‰º†...';
                statusMessage.className = 'status-text';
                progressContainer.style.display = 'block';
                resultContainer.style.display = 'flex';
                progressFill.style.width = '5%';
                progressPercent.textContent = '5%';

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || '‰∏ä‰º†Â§±Ë¥•');
                }

                const data = await response.json();
                currentTaskId = data.task_id;
                
                saveTaskState();
                
                statusMessage.textContent = 'Â§ÑÁêÜ‰∏≠...';
                cancelTaskBtn.style.display = 'inline-flex';
                cancelTaskBtn.disabled = false;
                cancelTaskBtn.textContent = '‚èπ ÂÅúÊ≠¢‰ªªÂä°';
                startPolling();
                loadHistory();
            } catch (error) {
                statusMessage.textContent = `ÈîôËØØ: ${error.message}`;
                statusMessage.className = 'status-text error';
                if (selectedFile) {
                    fileActions.classList.add('show');
                }
            }
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            setUploadEnabled(false);
            loadHistory(); // Âà∑Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÔºåÁ¶ÅÁî®ÁªßÁª≠ÊåâÈíÆ

            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/task/${currentTaskId}?last_index=${lastResultIndex}`);
                    
                    if (response.status === 404) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        statusMessage.textContent = '‰ªªÂä°Â∑≤Â§±ÊïàÔºàÊúçÂä°Âô®ÂèØËÉΩÂ∑≤ÈáçÂêØÔºâ';
                        statusMessage.className = 'status-text error';
                        cancelTaskBtn.style.display = 'none';
                        clearTaskState();
                        resetFileSelection();
                        setUploadEnabled(true);
                        return;
                    }
                    
                    const data = await response.json();

                    progressFill.style.width = `${data.progress}%`;
                    progressPercent.textContent = `${data.progress}%`;
                    statusMessage.textContent = data.message;
                    
                    if (data.total_rows > 0) {
                        resultCount.textContent = `(${data.total_results}/${data.total_rows})`;
                    }
                    
                    if (data.new_results && data.new_results.length > 0) {
                        appendResultRows(data.new_results);
                        lastResultIndex = data.total_results;
                        saveTaskState();
                    }
                    
                    if (data.status === 'processing' && data.total_results > 0) {
                        downloadPartialBtn.href = `/api/download_partial/${currentTaskId}`;
                        downloadPartialBtn.textContent = `‚¨á ‰∏ãËΩΩÂ∑≤Ëß£Êûê(${data.total_results}Êù°)`;
                        downloadPartialBtn.style.display = 'inline-flex';
                    }

                    if (data.status === 'completed') {
                        handleTaskCompleted(data);
                    } else if (data.status === 'cancelled') {
                        handleTaskCancelled(data);
                    } else if (data.status === 'error') {
                        handleTaskError(data);
                    }
                } catch (error) {
                    // ÈùôÈªòÂ§ÑÁêÜËΩÆËØ¢ÈîôËØØ
                }
            }, 500);
        }
        
        function handleTaskCompleted(data) {
            clearInterval(pollInterval);
            pollInterval = null;
            statusMessage.textContent = `ÂÆåÊàêÔºåÂÖ± ${data.result} Êù°`;
            downloadBtn.href = `/api/download/${currentTaskId}`;
            downloadBtn.textContent = '‚¨á ‰∏ãËΩΩÂÆåÊï¥CSV';
            downloadBtn.style.display = 'inline-flex';
            downloadPartialBtn.style.display = 'none';
            cancelTaskBtn.style.display = 'none';
            historyResumeBtn.style.display = 'none';
            clearTaskState();
            resetFileSelection();
            setUploadEnabled(true);
            loadHistory();
            showToast('Â§ÑÁêÜÂÆåÊàêÔºÅ', 'success');
        }
        
        function handleTaskCancelled(data) {
            clearInterval(pollInterval);
            pollInterval = null;
            cancelTaskBtn.style.display = 'none';
            
            // ËÆæÁΩÆÊ≠£Á°ÆÁöÑËøõÂ∫¶Êù°ÂíåÁä∂ÊÄÅÊ∂àÊÅØ
            if (data.total_rows > 0) {
                const progress = Math.round((data.total_results / data.total_rows) * 100);
                progressFill.style.width = `${progress}%`;
                progressPercent.textContent = `${progress}%`;
                statusMessage.textContent = data.message || `Â∑≤ÂÅúÊ≠¢ÔºåÂ∑≤Ëß£Êûê ${data.total_results}/${data.total_rows} Êù°`;
            } else {
                statusMessage.textContent = data.message || `Â∑≤ÂÅúÊ≠¢ÔºåÂ∑≤Ëß£Êûê ${data.total_results} Êù°`;
            }
            statusMessage.className = 'status-text';
            
            // Â¶ÇÊûúÊúâÊú™Â§ÑÁêÜÁöÑË°åÔºåÊòæÁ§∫ÁªßÁª≠ÊåâÈíÆ
            if (data.total_rows > 0 && data.total_results < data.total_rows) {
                const taskIdToResume = currentTaskId;
                historyResumeBtn.style.display = 'inline-flex';
                historyResumeBtn.disabled = false;
                historyResumeBtn.textContent = '‚ñ∂ ÁªßÁª≠Â§ÑÁêÜ';
                historyResumeBtn.onclick = () => resumeTaskFromHistory(taskIdToResume);
            } else {
                historyResumeBtn.style.display = 'none';
            }
            
            if (data.total_results > 0) {
                downloadBtn.href = `/api/download/${currentTaskId}`;
                downloadBtn.textContent = `‚¨á ‰∏ãËΩΩCSV(${data.total_results}Êù°)`;
                downloadBtn.style.display = 'inline-flex';
            }
            downloadPartialBtn.style.display = 'none';
            setUploadEnabled(true);
            loadHistory();
        }
        
        function handleTaskError(data) {
            clearInterval(pollInterval);
            pollInterval = null;
            cancelTaskBtn.style.display = 'none';
            
            // ËÆæÁΩÆÊ≠£Á°ÆÁöÑËøõÂ∫¶Êù°ÂíåÁä∂ÊÄÅÊ∂àÊÅØ
            if (data.total_rows > 0) {
                const progress = Math.round((data.total_results / data.total_rows) * 100);
                progressFill.style.width = `${progress}%`;
                progressPercent.textContent = `${progress}%`;
                statusMessage.textContent = `Â§±Ë¥•: ${data.error} (${data.total_results}/${data.total_rows})`;
            } else {
                statusMessage.textContent = `Â§±Ë¥•: ${data.error}`;
            }
            statusMessage.className = 'status-text error';
            
            // Â¶ÇÊûúÊúâÊú™Â§ÑÁêÜÁöÑË°åÔºåÊòæÁ§∫ÁªßÁª≠ÊåâÈíÆ
            if (data.total_rows > 0 && data.total_results < data.total_rows) {
                const taskIdToResume = currentTaskId;
                historyResumeBtn.style.display = 'inline-flex';
                historyResumeBtn.disabled = false;
                historyResumeBtn.textContent = '‚ñ∂ ÁªßÁª≠Â§ÑÁêÜ';
                historyResumeBtn.onclick = () => resumeTaskFromHistory(taskIdToResume);
            } else {
                historyResumeBtn.style.display = 'none';
            }
            
            if (data.total_results > 0) {
                downloadPartialBtn.href = `/api/download_partial/${currentTaskId}`;
                downloadPartialBtn.textContent = `‚¨á ‰∏ãËΩΩÂ∑≤Ëß£Êûê(${data.total_results}Êù°)`;
                downloadPartialBtn.style.display = 'inline-flex';
            }
            setUploadEnabled(true);
            loadHistory();
        }
        
        function resetFileSelection() {
            selectedFile = null;
            fileInput.value = '';
            uploadArea.classList.remove('has-file');
            uploadText.textContent = 'ÊãñÊãΩÊàñÁÇπÂáª‰∏ä‰º†ZIP';
            document.getElementById('xlsxFileItem').style.display = 'none';
            document.getElementById('xlsxFileName').value = '';
        }
        
        function appendResultRows(results) {
            results.forEach(result => {
                const tr = document.createElement('tr');
                tr.className = 'new-row';
                
                fieldOrder.forEach(field => {
                    const td = document.createElement('td');
                    const value = result[field];
                    if (value === null || value === undefined || value === '') {
                        td.textContent = '-';
                        td.className = 'empty-cell';
                    } else {
                        td.textContent = value;
                    }
                    tr.appendChild(td);
                });
                
                resultBody.appendChild(tr);
                tr.scrollIntoView({ behavior: 'smooth', block: 'end' });
            });
        }

        function renderResultList(results) {
            resultBody.innerHTML = '';
            lastResultIndex = results.length;
            results.forEach(result => {
                const tr = document.createElement('tr');
                fieldOrder.forEach(field => {
                    const td = document.createElement('td');
                    const value = result[field];
                    if (value === null || value === undefined || value === '') {
                        td.textContent = '-';
                        td.className = 'empty-cell';
                    } else {
                        td.textContent = value;
                    }
                    tr.appendChild(td);
                });
                resultBody.appendChild(tr);
            });
            resultContainer.style.display = 'flex';
            resultCount.textContent = `(${results.length}/${results.length})`;
        }

        // ÂéÜÂè≤ËÆ∞ÂΩï
        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                if (!res.ok) throw new Error('Ëé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•');
                const data = await res.json();
                renderHistory(data.items || []);
            } catch (err) {
                // ÈùôÈªòÂ§ÑÁêÜ
            }
        }

        function renderHistory(items) {
            historyBody.innerHTML = '';
            historyCount.textContent = items.length ? `(${items.length})` : '';

            if (!items.length) {
                historyBody.innerHTML = '<tr><td colspan="7" class="empty-cell">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</td></tr>';
                return;
            }

            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'history-row';
                
                const statusText = STATUS_LABELS[item.status] || item.status || '-';
                const resultText = item.result_count != null && item.total_rows != null
                    ? `${item.result_count}/${item.total_rows}`
                    : (item.result_count != null ? `${item.result_count}` : '-');

                // Â¶ÇÊûúÊúâ‰ªªÂä°Ê≠£Âú®Â§ÑÁêÜÔºåÊàñËÄÖÂΩìÂâç‰ªªÂä°Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåÁ¶ÅÁî®ÁÇπÂáª
                const isItemProcessing = CLICK_DISABLED_STATUS.includes(item.status);
                const clickDisabled = isItemProcessing || isProcessing;
                if (isItemProcessing) tr.classList.add('disabled');
                
                // ‰ªªÂä°ID
                const tdId = document.createElement('td');
                const linkBtn = document.createElement('span');
                linkBtn.className = `link-btn ${clickDisabled ? 'disabled' : ''}`;
                linkBtn.textContent = item.task_id || '-';
                if (!clickDisabled && item.task_id) {
                    linkBtn.onclick = () => loadHistoryResult(item.task_id);
                }
                tdId.appendChild(linkBtn);
                tr.appendChild(tdId);
                
                // Áä∂ÊÄÅÊ†áÁ≠æ
                const tdStatus = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = `status-badge ${item.status || ''}`;
                badge.textContent = statusText;
                tdStatus.appendChild(badge);
                tr.appendChild(tdStatus);
                
                // ËøõÂ∫¶
                const tdProgress = document.createElement('td');
                tdProgress.textContent = resultText;
                tr.appendChild(tdProgress);
                
                // ÂàõÂª∫Êó∂Èó¥
                const tdCreated = document.createElement('td');
                tdCreated.textContent = item.created_at ? formatTime(item.created_at) : '-';
                tr.appendChild(tdCreated);
                
                // ÂÆåÊàêÊó∂Èó¥
                const tdFinished = document.createElement('td');
                tdFinished.textContent = item.finished_at ? formatTime(item.finished_at) : '-';
                tr.appendChild(tdFinished);
                
                // Êìç‰ΩúÂàó
                const tdActions = document.createElement('td');
                const actionBtns = document.createElement('div');
                actionBtns.className = 'action-btns';
                
                // ÁªßÁª≠Â§ÑÁêÜÊåâÈíÆ - ‰ªÖÂØπ cancelled Êàñ error Áä∂ÊÄÅ‰∏îÊúâÊú™Â§ÑÁêÜË°åÁöÑ‰ªªÂä°ÊòæÁ§∫
                if ((item.status === 'cancelled' || item.status === 'error') && 
                    item.total_rows > 0 && item.result_count < item.total_rows) {
                    const resumeBtn = document.createElement('button');
                    resumeBtn.className = 'btn btn-primary btn-sm';
                    resumeBtn.textContent = '‚ñ∂ ÁªßÁª≠';
                    // Â¶ÇÊûúÊúâ‰ªªÂä°Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåÁ¶ÅÁî®ÁªßÁª≠ÊåâÈíÆ
                    if (isProcessing) {
                        resumeBtn.disabled = true;
                        resumeBtn.title = 'ËØ∑Á≠âÂæÖÂΩìÂâç‰ªªÂä°ÂÆåÊàê';
                    } else {
                        resumeBtn.onclick = () => resumeTaskFromHistory(item.task_id);
                    }
                    actionBtns.appendChild(resumeBtn);
                }
                
                // ‰∏ãËΩΩÊåâÈíÆ
                if (item.has_result) {
                    const link = document.createElement('a');
                    link.href = `/api/history/${item.task_id}/result`;
                    link.className = 'btn btn-success btn-sm';
                    link.textContent = '‚¨á ‰∏ãËΩΩ';
                    actionBtns.appendChild(link);
                }
                
                // Âà†Èô§ÊåâÈíÆ - Â§ÑÁêÜ‰∏≠ÁöÑ‰ªªÂä°‰∏çËÉΩÂà†Èô§
                if (item.status !== 'processing') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-sm';
                    deleteBtn.textContent = 'Âà†Èô§';
                    deleteBtn.onclick = () => deleteTaskFromHistory(item.task_id);
                    actionBtns.appendChild(deleteBtn);
                }
                
                if (actionBtns.children.length === 0) {
                    tdActions.textContent = '-';
                    tdActions.className = 'empty-cell';
                } else {
                    tdActions.appendChild(actionBtns);
                }
                tr.appendChild(tdActions);

                historyBody.appendChild(tr);
            });
        }
        
        function formatTime(isoString) {
            if (!isoString) return '-';
            const d = new Date(isoString);
            const pad = n => n.toString().padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        refreshHistoryBtn.addEventListener('click', () => {
            loadHistory();
            showToast('Â∑≤Âà∑Êñ∞', 'info', 1500);
        });

        // ‰æßËæπÊ†èÊéßÂà∂
        function showSidebar() {
            sidebarOverlay.classList.add('show');
            historySidebar.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideSidebar() {
            sidebarOverlay.classList.remove('show');
            historySidebar.classList.remove('show');
            document.body.style.overflow = '';
        }

        historyToggleBtn.addEventListener('click', () => {
            showSidebar();
            loadHistory();
        });

        sidebarClose.addEventListener('click', hideSidebar);
        sidebarOverlay.addEventListener('click', hideSidebar);

        // ESCÈîÆÂÖ≥Èó≠‰æßËæπÊ†è
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && historySidebar.classList.contains('show')) {
                hideSidebar();
            }
        });

        async function loadHistoryResult(taskId) {
            try {
                // Ê∏ÖÈô§ÂΩìÂâç‰ªªÂä°Áä∂ÊÄÅÔºàÊü•ÁúãÂéÜÂè≤‰∏çÊòØÊ≠£Âú®Â§ÑÁêÜÁöÑ‰ªªÂä°Ôºâ
                currentTaskId = null;
                clearTaskState();
                
                statusMessage.textContent = `Âä†ËΩΩÂéÜÂè≤ÁªìÊûú...`;
                progressContainer.style.display = 'block';
                
                // Ëé∑Âèñ‰ªªÂä°ËØ¶ÊÉÖ
                const detailRes = await fetch(`/api/history/${taskId}`);
                let taskDetail = null;
                if (detailRes.ok) {
                    taskDetail = await detailRes.json();
                }
                
                const res = await fetch(`/api/history/${taskId}/result_json`);
                if (!res.ok) throw new Error('Ëé∑ÂèñÂéÜÂè≤ÁªìÊûúÂ§±Ë¥•');
                const data = await res.json();
                renderResultList(data.items || []);
                downloadBtn.href = `/api/history/${taskId}/result`;
                downloadBtn.textContent = '‚¨á ‰∏ãËΩΩÂÆåÊï¥CSV';
                downloadBtn.style.display = 'inline-flex';
                downloadPartialBtn.style.display = 'none';
                cancelTaskBtn.style.display = 'none';
                
                // Ê†πÊçÆ‰ªªÂä°Áä∂ÊÄÅÊòæÁ§∫ËøõÂ∫¶ÂíåÁªßÁª≠ÊåâÈíÆ
                historyResumeBtn.style.display = 'none';
                if (taskDetail && taskDetail.total_rows > 0) {
                    const resultCount = taskDetail.result_count || (data.items ? data.items.length : 0);
                    const totalRows = taskDetail.total_rows;
                    const progress = Math.round((resultCount / totalRows) * 100);
                    progressFill.style.width = `${progress}%`;
                    progressPercent.textContent = `${progress}%`;
                    
                    const statusText = STATUS_LABELS[taskDetail.status] || taskDetail.status || '';
                    statusMessage.textContent = `ÂéÜÂè≤ËÆ∞ÂΩï: ${taskId} (${statusText} ${resultCount}/${totalRows})`;
                    
                    // Êú™ÂÆåÊàêÁöÑ‰ªªÂä°ÊòæÁ§∫ÁªßÁª≠ÊåâÈíÆÔºàÈùûÂ§ÑÁêÜ‰∏≠„ÄÅÈùûÂ∑≤ÂÆåÊàêÔºâ
                    if ((taskDetail.status === 'cancelled' || taskDetail.status === 'error') && 
                        resultCount < totalRows && !isProcessing) {
                        historyResumeBtn.style.display = 'inline-flex';
                        historyResumeBtn.disabled = false;
                        historyResumeBtn.textContent = '‚ñ∂ ÁªßÁª≠Â§ÑÁêÜ';
                        historyResumeBtn.onclick = () => resumeTaskFromHistory(taskId);
                    }
                } else {
                    progressFill.style.width = '100%';
                    progressPercent.textContent = '100%';
                    statusMessage.textContent = `ÂéÜÂè≤ËÆ∞ÂΩï: ${taskId}`;
                }
                statusMessage.className = 'status-text';
            } catch (err) {
                statusMessage.textContent = `Âä†ËΩΩÂ§±Ë¥•: ${err.message}`;
                statusMessage.className = 'status-text error';
            }
        }

        async function resumeTaskFromHistory(taskId) {
            currentTaskId = taskId;
            progressContainer.style.display = 'block';
            statusMessage.textContent = 'Ê≠£Âú®ÊÅ¢Â§ç‰ªªÂä°...';
            
            try {
                const response = await fetch(`/api/resume/${taskId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    let errorMessage = 'ÊÅ¢Â§çÂ§±Ë¥•';
                    if (response.status === 404) {
                        errorMessage = '‰ªªÂä°‰∏çÂ≠òÂú®ÊàñÊó†Ê≥ïÊÅ¢Â§ç';
                    } else if (response.status === 400) {
                        try {
                            const errData = await response.json();
                            errorMessage = errData.detail || 'ÊÅ¢Â§çÂ§±Ë¥•';
                        } catch (e) {
                            errorMessage = '‰ªªÂä°Ê≠£Âú®Â§ÑÁêÜ‰∏≠';
                        }
                    } else {
                        try {
                            const errData = await response.json();
                            errorMessage = errData.detail || 'ÊÅ¢Â§çÂ§±Ë¥•';
                        } catch (e) {
                            errorMessage = `ÊÅ¢Â§çÂ§±Ë¥• (Áä∂ÊÄÅÁ†Å: ${response.status})`;
                        }
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                statusMessage.textContent = data.message || 'Ê≠£Âú®ÊÅ¢Â§çÂ§ÑÁêÜ...';
                statusMessage.className = 'status-text';
                resultContainer.style.display = 'flex';
                
                // Âä†ËΩΩÂ∑≤ÊúâÁöÑÁªìÊûú
                try {
                    const resultRes = await fetch(`/api/history/${taskId}/result_json`);
                    if (resultRes.ok) {
                        const resultData = await resultRes.json();
                        renderResultList(resultData.items || []);
                    }
                } catch (e) {
                    // ÂøΩÁï•
                }
                
                historyResumeBtn.style.display = 'none';
                cancelTaskBtn.style.display = 'inline-flex';
                cancelTaskBtn.disabled = false;
                cancelTaskBtn.textContent = '‚èπ ÂÅúÊ≠¢‰ªªÂä°';
                
                saveTaskState();
                startPolling();
                loadHistory();
                showToast('‰ªªÂä°Â∑≤ÊÅ¢Â§ç', 'success');
            } catch (error) {
                historyResumeBtn.style.display = 'none';
                statusMessage.textContent = error.message;
                statusMessage.className = 'status-text error';
                await showMessage('error', error.message);
                loadHistory();
            }
        }

        async function deleteTaskFromHistory(taskId) {
            const confirmed = await showConfirm(
                `Á°ÆÂÆöË¶ÅÂà†Èô§‰ªªÂä° ${taskId} ÁöÑÊï∞ÊçÆÂêóÔºü`,
                'Ê≥®ÊÑèÔºöÊ≠§Êìç‰ΩúÂ∞ÜÂà†Èô§ËØ•‰ªªÂä°ÁöÑÊâÄÊúâÊï∞ÊçÆÊñá‰ª∂„ÄÇ',
                'Âà†Èô§Á°ÆËÆ§'
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/api/history/${taskId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'Âà†Èô§Â§±Ë¥•');
                }
                
                // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÊ≠£Âú®Êü•ÁúãÁöÑ‰ªªÂä°ÔºåÊ∏ÖÈô§ÊòæÁ§∫
                if (currentTaskId === taskId) {
                    resultBody.innerHTML = '';
                    resultContainer.style.display = 'none';
                    progressContainer.style.display = 'none';
                    currentTaskId = null;
                    clearTaskState();
                }
                
                loadHistory();
                showToast('Â∑≤Âà†Èô§', 'success');
            } catch (error) {
                await showMessage('error', `Âà†Èô§Â§±Ë¥•: ${error.message}`);
            }
        }
    </script>
</body>
</html>
