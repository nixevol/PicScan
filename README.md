# 固移工单数据处理工具

一款用于自动处理固移融合工单数据的工具，支持从 Excel 文件中提取图片、识别速率、解析 4G/5G 测试日志并生成汇总报表。

## ✨ 功能特性

- 📊 **Excel 数据处理**：自动解析工单 Excel 文件，支持字段动态匹配
- 🖼️ **图片识别**：提取 Excel 中嵌入的速率截图（支持 WPS DISPIMG 格式），OCR 识别上传/下载速率
- 📱 **4G/5G 日志解析**：自动解析 Cellular 测试日志，提取信号参数（RSRP、SINR、CI 等）
- 🌍 **智能经纬度提取**：优先使用 5G 日志经纬度，无效时自动切换至 4G 日志
- 🌐 **Web 界面**：简洁美观的网页操作界面，实时显示处理进度
- ⏹️ **任务控制**：支持取消正在处理的任务，可下载部分结果
- 💾 **状态保持**：刷新页面后自动恢复处理进度
- 📦 **一键打包**：支持打包为独立 EXE 程序

## 📋 系统要求

- Python 3.10+
- Windows 10/11

## 🚀 快速开始

### 方式一：源码运行

1. **安装依赖**
```bash
pip install -r requirements.txt
```

2. **启动服务**
```bash
python main.py
```
或双击运行 `run.bat`

3. **打开浏览器**
访问 http://localhost:8000

### 方式二：EXE 程序

1. 双击运行 `固移工单数据处理工具.exe`
2. 程序会自动打开浏览器
3. 按 `Ctrl+C` 关闭服务

## 📖 使用说明

### 准备数据

将以下文件打包为 ZIP 压缩包：

```
工单数据.zip
├── (固移融合工单登记)表格视图.xlsx    # 工单 Excel 文件
├── 4G测试log（cellular）/             # 4G 测试日志目录
│   ├── xxx_4G_LTE_xxx.csv
│   └── ...
└── 5G测试log（cellular）/             # 5G 测试日志目录
    ├── xxx_5G_NR_xxx.csv
    └── ...
```

### Excel 文件要求

必须包含以下列（列名需匹配，顺序不限）：
- **工单号**：必填，用于数据关联
- **5G速率图（移动爱家）**：包含速率截图的单元格
- **4G测试log（cellular）**：4G 日志文件名
- **5G测试log（cellular）**：5G 日志文件名

> 💡 支持旧版字段名 `4G测试log（cellular）_1/_2` 和 `5G测试log（cellular）_1/_2`

### 操作步骤

1. （可选）在"Excel文件"输入框中指定要解析的 xlsx 文件名
2. 拖拽或点击上传 ZIP 文件
3. 点击"开始处理"按钮
4. 实时查看解析进度和结果
5. 处理完成后点击"下载完整CSV"

### 功能按钮说明

| 按钮 | 说明 |
|------|------|
| ▶ 开始处理 | 选择文件后点击开始处理 |
| ✕ 取消 | 取消已选择的文件 |
| ⏹ 取消任务 | 停止正在处理的任务 |
| ⬇ 下载已解析 | 下载当前已解析的部分数据 |
| ⬇ 下载完整CSV | 处理完成后下载完整结果 |

## 📄 输出格式

生成的 CSV 文件包含以下字段：

| 字段名 | 说明 | 来源 |
|--------|------|------|
| 工单号 | 工单唯一标识 | Excel |
| 经度 | 测试点经度 | 5G/4G 日志 |
| 纬度 | 测试点纬度 | 5G/4G 日志 |
| 上传速率Mbps | 上传速度 | 速率图 OCR |
| 下载速率Mbps | 下载速度 | 速率图 OCR |
| ECI | 4G 小区标识 | 4G 日志 |
| RSRP | 4G 参考信号功率 | 4G 日志 |
| SINR | 4G 信噪比 | 4G 日志 |
| NR-CI | 5G 小区标识 | 5G 日志 |
| SS-RSRP | 5G 参考信号功率 | 5G 日志 |
| SS-SINR | 5G 信噪比 | 5G 日志 |

## 🔧 打包为 EXE

```bash
python build.py
```

打包完成后，输出目录为 `dist/固移工单数据处理工具/`

## 📁 项目结构

```
PicScan/
├── main.py              # FastAPI 主程序
├── data_processor.py    # 数据处理核心逻辑
├── speed_recognizer.py  # OCR 速率识别模块
├── index.html           # Web 前端页面
├── requirements.txt     # Python 依赖
├── build.py             # 打包脚本
├── run.bat              # 快速启动批处理
└── data/                # 任务数据目录（运行时生成）
```

## ⚙️ 配置说明

### 日志目录匹配规则

- 4G 日志目录：包含 `4G` 关键字的目录
- 5G 日志目录：包含 `5G` 关键字的目录
- 日志文件：CSV 或 XLSX 格式

### 经纬度提取优先级

1. 优先使用 **5G 日志** 中的经纬度（`LONGITUDE`、`LATITUDE` 字段）
2. 5G 日志无有效经纬度时，使用 **4G 日志** 中的经纬度
3. 在同类日志中，优先选择 **有经纬度且信号最强** 的记录

### 信号值选取规则

- 4G：选择 RSRP 最小（信号最强）的记录
- 5G：选择 SS-RSRP 最小（信号最强）的记录

## 🐛 常见问题

### Q: 启动后浏览器显示无法访问？
A: 检查端口 8000 是否被占用，或等待几秒后刷新页面。

### Q: OCR 识别速率失败？
A: 确保图片清晰度足够，且包含"上传速度"、"下载速度"等关键字。

### Q: 找不到日志文件？
A: 检查 Excel 中的文件名是否与实际文件名一致（注意冒号会被替换为下划线）。

### Q: 刷新页面后任务丢失？
A: 任务状态会自动保存到浏览器本地存储，刷新后应自动恢复。如服务器重启则任务丢失。

### Q: EXE 首次运行很慢？
A: 首次运行需要下载 OCR 模型文件（约 100MB），请耐心等待。

## 📝 更新日志

### v1.0.0
- 初始版本
- 支持 Excel 数据处理和图片提取
- 支持 4G/5G 日志解析
- Web 界面实时进度显示
- 任务取消和部分下载功能
- 状态持久化（浏览器刷新恢复）
- 支持打包为 EXE

## 📄 许可证

MIT License

